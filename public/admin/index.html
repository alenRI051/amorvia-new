<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Amorvia Admin</title>
<meta name="robots" content="noindex,nofollow" />

<style>
:root{
  --bg:#050b18;
  --panel:rgba(2,6,23,.35);
  --border:#1e293b;
  --muted:rgba(226,232,240,.72);
  --text:#e2e8f0;
  --row:rgba(30,41,59,.5);
  --good:#22c55e;
  --mid:#eab308;
  --bad:#94a3b8;
  --link:#93c5fd;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}
main{max-width:1200px;margin:0 auto;padding:18px 14px 28px}
h1,h2,h3,h4{margin:0 0 10px;font-weight:700}
h1{font-size:20px} h2{font-size:18px} h3{font-size:16px} h4{font-size:14px}
p{margin:0 0 12px;color:var(--muted);font-size:13px}
a{color:var(--link)}
.panel{
  margin:16px 0;
  padding:14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--panel);
}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
label{font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
input,select,button{
  padding:6px 8px;
  background:rgba(2,6,23,.55);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:10px;
}
button{cursor:pointer}
button:hover{background:rgba(148,163,184,.16)}
.grid{display:grid;grid-template-columns:1.2fr .9fr;gap:14px}
.box{border:1px solid var(--border);border-radius:12px;overflow:auto;background:rgba(2,6,23,.18)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px solid var(--row)}
th{font-size:12px;text-align:left}
.num{text-align:right;font-variant-numeric:tabular-nums}
.mono{font-family:ui-monospace,monospace}
.badge,.kind{
  display:inline-block;padding:2px 8px;border-radius:999px;
  font-size:11px;border:1px solid rgba(148,163,184,.35);
  white-space:nowrap
}
.badge.good{border-color:rgba(34,197,94,.6);color:rgba(34,197,94,.95)}
.badge.mid{border-color:rgba(234,179,8,.6);color:rgba(234,179,8,.95)}
.badge.bad{color:rgba(148,163,184,.95)}
.kind.choice{border-color:rgba(34,197,94,.6);color:rgba(34,197,94,.95)}
.kind.scene{border-color:rgba(234,179,8,.6);color:rgba(234,179,8,.95)}
.kind.other{color:rgba(148,163,184,.95)}
.rowlink{background:none;border:none;color:inherit;cursor:pointer;text-align:left;padding:0}
.pill{
  display:inline-flex;gap:8px;align-items:center;
  border:1px solid var(--border);border-radius:999px;
  padding:6px 10px;font-size:12px
}
</style>
</head>

<body>
<main>
<h1>Amorvia Admin</h1>
<p>Playtest analytics (no backend changes).</p>

<section class="panel">
<h2>Playtest Insights</h2>

<div class="controls">
<label>Date <input id="date" type="date"></label>
<label>Max logs <input id="maxLogs" type="number" value="200"></label>
<label><input id="onlyHumans" type="checkbox"> Only humans</label>
<label>Scenario
<select id="scenarioFilter"><option value="">All</option></select>
</label>
<button id="build">Build</button>
<span id="status"></span>
</div>

<div class="grid">
<div>
<h3>Top choices</h3>
<div id="choices" class="box"></div>
</div>

<div>
<h3>Sessions</h3>
<div id="filters"></div>
<div id="sessions" class="box"></div>
<h3>Session drill-down</h3>
<div id="drill" class="box" style="padding:10px"></div>
</div>
</div>
</section>

<section class="panel">
<h2>Drop-off</h2>
<p>Last meaningful event per session.</p>
<div class="controls">
<button id="clearDrop" style="display:none">Clear drop-off filter</button>
</div>
<div id="dropoff" class="box"></div>
</section>
</main>

<script>
const $=s=>document.querySelector(s)
const el=(t,a={},c=[])=>{
  const n=document.createElement(t)
  for(const k in a) n.setAttribute(k,a[k])
  c.forEach(x=>{
    if(x instanceof Node)n.appendChild(x)
    else n.appendChild(document.createTextNode(x))
  })
  return n
}
const fmt=ms=>ms<6e4?Math.round(ms/1e3)+"s":Math.floor(ms/6e4)+"m"

let STATE={sessions:[],drop:null}

async function build(){
  $("#status").textContent="Loadingâ€¦"
  const date=$("#date").value
  const res=await fetch(`/api/list-logs?date=${date}`)
  const {items}=await res.json()
  const map=new Map()
  for(const it of items){
    const j=await fetch(it.url).then(r=>r.json())
    const sid=j.sessionId
    if(!map.has(sid))map.set(sid,{sid,events:[],blobs:[],first:1e18,last:0})
    const s=map.get(sid)
    s.blobs.push(it.url)
    for(const e of j.events||[]){
      s.events.push(e)
      s.first=Math.min(s.first,e.ts||Date.now())
      s.last=Math.max(s.last,e.ts||0)
    }
  }
  STATE.sessions=[...map.values()].map(s=>{
    s.duration=s.last-s.first
    s.lastEvent=s.events.filter(e=>e.type!=="page_visibility").pop()
    return s
  })
  render()
  $("#status").textContent=`Sessions ${STATE.sessions.length}`
}

function render(){
  renderDropoff()
  renderSessions()
}

function renderDropoff(){
  $("#dropoff").innerHTML=""
  const total=STATE.sessions.length
  const buckets={}
  STATE.sessions.forEach(s=>{
    const e=s.lastEvent||{}
    const key=(e.type||"other")+"||"+(e.text||e.type)
    if(!buckets[key])buckets[key]={kind:e.type,text:e.text,count:0}
    buckets[key].count++
  })
  const table=el("table",{},[
    el("thead",{},[el("tr",{},[
      el("th",{},["Drop-off"]),
      el("th",{class:"num"},["Sessions"]),
      el("th",{class:"num"},["%"])
    ])])
  ])
  const tb=el("tbody")
  Object.entries(buckets).forEach(([k,b])=>{
    const kind=b.kind==="choice_click"?"choice":b.kind==="scenario_loaded"?"scene":"other"
    const row=el("tr",{},[
      el("td",{},[
        el("button",{class:"rowlink"},[
          el("span",{class:`kind ${kind}`},[kind.toUpperCase()]),
          " "+(b.text||b.kind)
        ])
      ]),
      el("td",{class:"num"},[b.count]),
      el("td",{class:"num"},[((b.count/total)*100).toFixed(1)+"%"])
    ])
    row.onclick=()=>{STATE.drop=k;renderSessions();$("#clearDrop").style.display="inline"}
    tb.appendChild(row)
  })
  table.appendChild(tb)
  $("#dropoff").appendChild(table)
}

function renderSessions(){
  $("#sessions").innerHTML=""
  const table=el("table")
  const tb=el("tbody")
  STATE.sessions.filter(s=>{
    if(!STATE.drop)return true
    const e=s.lastEvent||{}
    return (e.type+"||"+(e.text||e.type))===STATE.drop
  }).forEach(s=>{
    tb.appendChild(el("tr",{},[
      el("td",{class:"mono"},[s.sid]),
      el("td",{class:"num"},[fmt(s.duration)])
    ]))
  })
  table.appendChild(tb)
  $("#sessions").appendChild(table)
}

$("#build").onclick=build
$("#clearDrop").onclick=()=>{STATE.drop=null;renderSessions();$("#clearDrop").style.display="none"}
$("#date").value=new Date().toISOString().slice(0,10)
build()
</script>
</body>
</html>


